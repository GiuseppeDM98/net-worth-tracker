import { Timestamp } from 'firebase/firestore';

export type DividendType = 'ordinary' | 'extraordinary' | 'interim' | 'final';

// Dividend payment record for a specific asset.
// Supports manual entry and automatic scraping from Borsa Italiana (via ISIN).
// Currency conversion to EUR is automatic for non-EUR dividends using Frankfurter API.
export interface Dividend {
  id: string;
  userId: string;
  assetId: string;
  // WARNING: assetTicker and assetName are denormalized for query performance.
  // When updating an asset's ticker/name, also update all associated dividends via bulk update.
  assetTicker: string; // Denormalized for efficient queries
  assetName: string; // Denormalized for efficient queries
  assetIsin?: string; // Optional ISIN code
  exDate: Date | Timestamp; // Ex-dividend date
  paymentDate: Date | Timestamp; // Payment date
  dividendPerShare: number; // Dividend amount per share
  quantity: number; // Number of shares owned at ex-date
  grossAmount: number; // Total gross dividend (dividendPerShare × quantity)
  taxAmount: number; // Withholding tax amount
  netAmount: number; // Net dividend after tax (grossAmount - taxAmount)
  currency: string; // Currency code (e.g., EUR, USD)
  dividendType: DividendType; // Type of dividend
  notes?: string; // Optional notes
  isAutoGenerated: boolean; // True if created via Borsa Italiana scraping (requires ISIN), false if manually entered
  expenseId?: string; // Reference to corresponding expense entry (if synced)
  // Currency conversion fields (populated automatically if currency !== EUR)
  // Uses Frankfurter API with 24h cache. If conversion fails, these fields remain undefined.
  // Exchange rate format: 1 originalCurrency = X EUR (e.g., 1 USD = 0.92 EUR)
  grossAmountEur?: number; // Gross amount converted to EUR
  taxAmountEur?: number; // Tax amount converted to EUR
  netAmountEur?: number; // Net amount converted to EUR
  exchangeRate?: number; // Exchange rate used for conversion (originalCurrency -> EUR)
  createdAt: Date | Timestamp;
  updatedAt: Date | Timestamp;
}

export interface DividendFormData {
  assetId: string;
  exDate: Date;
  paymentDate: Date;
  dividendPerShare: number;
  quantity: number;
  grossAmount: number;
  taxAmount: number;
  netAmount: number;
  currency: string;
  dividendType: DividendType;
  notes?: string;
  isAutoGenerated: boolean;
}

export interface DividendStats {
  totalGross: number;
  totalTax: number;
  totalNet: number;
  count: number;
  byAsset: {
    [assetId: string]: {
      assetTicker: string;
      assetName: string;
      totalGross: number;
      totalTax: number;
      totalNet: number;
      count: number;
    };
  };
  byType: {
    [type in DividendType]: {
      totalGross: number;
      totalTax: number;
      totalNet: number;
      count: number;
    };
  };
  // Yield on Cost (YOC) Analysis
  //
  // YOC measures dividend yield based on your original purchase price (average cost),
  // not the current market price. This shows the return on your initial investment.
  //
  // Formula: YOC% = (TTM Gross Dividends / Total Cost Basis) × 100
  //
  // Example:
  // - Bought 100 shares at €50/share (cost basis: €5,000)
  // - Current price: €80/share
  // - TTM dividends: €300
  // - YOC = (€300 / €5,000) × 100 = 6%
  // - Current Yield = (€300 / €8,000) × 100 = 3.75%
  //
  // YOC > Current Yield indicates dividend growth over time.
  portfolioYieldOnCost?: number;
  totalCostBasis?: number;
  yieldOnCostAssets?: YieldOnCostAsset[];
}

export interface YieldOnCostAsset {
  assetId: string;
  assetTicker: string;
  assetName: string;
  quantity: number;
  averageCost: number;
  currentPrice: number;
  ttmGrossDividends: number; // TTM (Trailing Twelve Months) gross dividends: sum of last 12 months of dividend payments
  yocPercentage: number;
  currentYieldPercentage: number;
  difference: number;
}

export interface ScrapedDividend {
  exDate: Date;
  paymentDate: Date;
  dividendPerShare: number;
  currency: string;
  dividendType: DividendType;
}

export interface DividendsByAsset {
  assetId: string;
  assetTicker: string;
  assetName: string;
  dividends: Dividend[];
  totalGross: number;
  totalTax: number;
  totalNet: number;
}
